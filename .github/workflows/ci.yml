name: NetBoozt CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # Tauri Build (Production - Windows Only)
  # ============================================
  build-tauri:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: platforms/tauri/pnpm-lock.yaml
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: platforms/tauri/src-tauri -> target
    
    - name: Install frontend dependencies
      working-directory: platforms/tauri
      run: pnpm install --frozen-lockfile
    
    - name: Check Rust formatting
      working-directory: platforms/tauri/src-tauri
      run: cargo fmt --check
    
    - name: Rust linting
      working-directory: platforms/tauri/src-tauri
      run: cargo clippy -- -D warnings
      continue-on-error: true
    
    - name: Build Tauri app
      working-directory: platforms/tauri
      run: pnpm tauri build
    
    - name: Upload MSI artifact
      uses: actions/upload-artifact@v4
      with:
        name: netboozt-msi
        path: platforms/tauri/src-tauri/target/release/bundle/msi/*.msi
    
    - name: Upload NSIS artifact
      uses: actions/upload-artifact@v4
      with:
        name: netboozt-setup
        path: platforms/tauri/src-tauri/target/release/bundle/nsis/*.exe

  # ============================================
  # Python Legacy (Optional - for backwards compat)
  # ============================================
  lint-python-legacy:
    runs-on: windows-latest
    if: ${{ github.event_name == 'pull_request' }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort
    
    - name: Check if Python source exists
      id: check-python
      run: |
        if (Test-Path "windows/src") { echo "exists=true" >> $env:GITHUB_OUTPUT } else { echo "exists=false" >> $env:GITHUB_OUTPUT }
      shell: pwsh
    
    - name: Lint with flake8
      if: steps.check-python.outputs.exists == 'true'
      run: |
        flake8 windows/src --count --select=E9,F63,F7,F82 --show-source --statistics
      continue-on-error: true
    
    - name: Format check with black
      if: steps.check-python.outputs.exists == 'true'
      run: |
        black --check windows/src
      continue-on-error: true
